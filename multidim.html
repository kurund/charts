<!DOCTYPE html>
<html>
<head>
    <title>Multidime POC</title>

    <link rel="stylesheet" href="node_modules/dc/dc.min.css">
    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.css">

    <!-- include require js files -->
    <script type="text/javascript" src="node_modules/d3/d3.min.js"></script>
    <script type="text/javascript" src="node_modules/crossfilter2/crossfilter.min.js"></script>
    <script type="text/javascript" src="node_modules/dc/dc.min.js"></script>
</head>

<body>

<div class="container">
    <h1>My Dashboard</h1>
    <div class="row">
        <ul class="nav nav-pills">
            <li role="presentation"><a href="index.html">Home</a></li>
            <li role="presentation"><a href="geochart.html">Geochart POC</a></li>
            <li role="presentation" class="active"><a href="#">Multidime POC</a></li>
        </ul>
    </div>
    <script type="text/javascript" src="header.js"></script>
    <h3>Vintage</h3>
    <div id="chart-ring-year" style="width:300px; height:300px">
        <div class="reset" style="visibility: hidden;">selected: <span class="filter"></span>
            <a href="javascript:yearRingChart.filterAll();dc.redrawAll();">reset</a>
        </div>
    </div>
    <div id="chart-hist-spend" style="width:300px; height:300px">
        <div class="reset" style="visibility: hidden;">range: <span class="filter"></span>
            <a href="javascript:spendHistChart.filterAll();dc.redrawAll();">reset</a>
        </div>
    </div>
    <h3>Pool Type</h3>
    <div id="chart-row-spenders">
        <div class="reset" style="visibility: hidden;">selected: <span class="filter"></span>
            <a href="javascript:spenderRowChart.filterAll();dc.redrawAll();">reset</a>
        </div>
    </div>

    <script type="text/javascript">
        var yearRingChart   = dc.pieChart("#chart-ring-year"),
            spendHistChart  = dc.barChart("#chart-hist-spend"),
            spenderRowChart = dc.rowChart("#chart-row-spenders");
        // use static or load via d3.csv("spendData.csv", function(error, spendData) {/* do stuff */});
        var spendData = [
            {Name: 'FHAVA', Spent: '1,196,235.00', Year: 2008},
            {Name: 'FHAVA', Spent: '9,484,832.00', Year: 2009},
            {Name: 'GEN', Spent: '4,726,796,226.00', Year: 2008},
            {Name: 'GEN', Spent: '8,302,925,754.00', Year: 2009},
            {Name: 'GEN', Spent: '18,498,798,749.00', Year: 2010},
            {Name: 'IO', Spent: '7,556,478,094.00', Year: 2008},
            {Name: 'IO', Spent: '7,556,478,094.00', Year: 2009}
            //{Name: 'JUMBO', Spent: '231,983,779.00', Year: 2010}
        ];
        // normalize/parse data
        spendData.forEach(function(d) {
            d.Spent = d.Spent.match(/\d+/);
        });
        // set crossfilter
        var ndx = crossfilter(spendData),
            yearDim  = ndx.dimension(function(d) {return +d.Year;}),
            //spendDim = ndx.dimension(function(d) {return Math.floor(d.Spent/10);}),
            spendDim = ndx.dimension(function(d) {return d.Spent;}),
            nameDim  = ndx.dimension(function(d) {return d.Name;}),
            spendPerYear = yearDim.group().reduceSum(function(d) {return +d.Spent;}),
            spendPerName = nameDim.group().reduceSum(function(d) {return +d.Spent;}),
            spendHist    = spendDim.group().reduceCount();
        yearRingChart
            .dimension(yearDim)
            .group(spendPerYear)
            .innerRadius(50)
            .controlsUseVisibility(true);
        spendHistChart
            .dimension(spendDim)
            .group(spendHist)
            .x(d3.scale.linear().domain([0,10]))
            .elasticY(true)
            .controlsUseVisibility(true);
        spendHistChart.xAxis().tickFormat(function(d) {return d*10}); // convert back to base unit
        spendHistChart.yAxis().ticks(2);
        spenderRowChart
            .dimension(nameDim)
            .group(spendPerName)
            .elasticX(true)
            .controlsUseVisibility(true);
        function show_empty_message(chart) {
            var is_empty = d3.sum(chart.group().all().map(chart.valueAccessor())) === 0;
            var data = is_empty ? [1] : [];
            var empty = chart.svg().selectAll('.empty-message').data(data);
            empty.enter().append('text')
                .text('NO DATA!')
                .attr({
                    'text-anchor': 'middle',
                    'alignment-baseline': 'middle',
                    class: 'empty-message',
                    x: chart.margins().left + chart.effectiveWidth()/2,
                    y: chart.margins().top + chart.effectiveHeight()/2
                })
                .style('opacity', 0);
            empty.transition().duration(1000).style('opacity', 1);
            empty.exit().remove();
        }
        spendHistChart.on('pretransition', show_empty_message);
        spenderRowChart.on('pretransition', show_empty_message);
        dc.renderAll();
    </script>

</div>
</body>
</html>
